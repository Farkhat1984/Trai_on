<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion AI Platform - Панель управления</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Страница входа */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 60px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 450px;
            width: 100%;
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 32px;
        }

        .login-box p {
            color: #666;
            margin-bottom: 40px;
            font-size: 16px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            padding: 16px 30px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
        }

        .google-btn:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .google-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Основной интерфейс */
        .dashboard {
            display: none;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #333;
            font-size: 32px;
            font-weight: 700;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 22px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            background: white;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .product-price {
            color: #667eea;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .product-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .product-actions .btn {
            flex: 1;
            margin: 0;
            padding: 8px;
            font-size: 13px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: 700;
            color: #999;
            cursor: pointer;
            line-height: 20px;
        }

        .close-modal:hover {
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <!-- Страница входа -->
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <h1>Fashion AI Platform</h1>
            <p>Войдите через Google, чтобы продолжить</p>

            <button class="google-btn" onclick="loginWithGoogle()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Войти через Google
            </button>
        </div>
    </div>

    <!-- Панель магазина -->
    <div id="shopDashboard" class="dashboard">
        <div class="header">
            <h1>Панель магазина</h1>
            <div class="user-info">
                <div class="user-avatar" id="shopAvatar">М</div>
                <span id="shopName">Мой магазин</span>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
        </div>

        <div class="container">
            <div id="alertContainer"></div>

            <!-- Статистика -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Всего товаров</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Активных</h3>
                    <div class="value" id="activeProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Просмотры</h3>
                    <div class="value" id="totalViews">0</div>
                </div>
                <div class="stat-card">
                    <h3>Примерки</h3>
                    <div class="value" id="totalTryOns">0</div>
                </div>
            </div>

            <!-- Профиль магазина -->
            <div class="section">
                <h2>Профиль магазина</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Название магазина</label>
                        <input type="text" id="profileShopName" placeholder="Название вашего магазина">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="profileDescription" placeholder="Расскажите о вашем магазине"></textarea>
                </div>
                <button class="btn btn-primary" onclick="updateShopProfile()">Сохранить изменения</button>
            </div>

            <!-- Товары -->
            <div class="section">
                <h2>Мои товары</h2>
                <button class="btn btn-primary" onclick="openAddProductModal()">+ Добавить товар</button>
                <div id="productsList" class="products-grid"></div>
            </div>
        </div>
    </div>

    <!-- Панель администратора -->
    <div id="adminDashboard" class="dashboard">
        <div class="header">
            <h1>Панель администратора</h1>
            <div class="user-info">
                <div class="user-avatar" id="adminAvatar">А</div>
                <span id="adminName">Администратор</span>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
        </div>

        <div class="container">
            <div id="adminAlertContainer"></div>

            <!-- Статистика платформы -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Всего пользователей</h3>
                    <div class="value" id="adminTotalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Магазинов</h3>
                    <div class="value" id="adminTotalShops">0</div>
                </div>
                <div class="stat-card">
                    <h3>Товаров</h3>
                    <div class="value" id="adminTotalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>На модерации</h3>
                    <div class="value" id="adminPendingModeration">0</div>
                </div>
            </div>

            <!-- Вкладки -->
            <div class="section">
                <div class="tabs">
                    <button class="tab active" onclick="switchAdminTab('moderation')">Модерация товаров</button>
                    <button class="tab" onclick="switchAdminTab('refunds')">Возвраты</button>
                    <button class="tab" onclick="switchAdminTab('settings')">Настройки</button>
                </div>

                <!-- Модерация -->
                <div id="moderationTab" class="tab-content active">
                    <h2>Товары на модерации</h2>
                    <div id="moderationQueue" class="products-grid"></div>
                </div>

                <!-- Возвраты -->
                <div id="refundsTab" class="tab-content">
                    <h2>Запросы на возврат</h2>
                    <div class="form-group" style="max-width: 300px;">
                        <label>Статус</label>
                        <select id="refundStatusFilter" onchange="loadRefunds()">
                            <option value="">Все</option>
                            <option value="pending">Ожидают</option>
                            <option value="approved">Одобрены</option>
                            <option value="rejected">Отклонены</option>
                        </select>
                    </div>
                    <div id="refundsList"></div>
                </div>

                <!-- Настройки -->
                <div id="settingsTab" class="tab-content">
                    <h2>Настройки платформы</h2>
                    <div id="settingsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления товара -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeAddProductModal()">&times;</span>
                <h2>Добавить товар</h2>
            </div>
            <div class="form-group">
                <label>Название товара *</label>
                <input type="text" id="productName" placeholder="Например: Красное платье">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea id="productDescription" placeholder="Опишите ваш товар"></textarea>
            </div>
            <div class="form-group">
                <label>Цена (USD) *</label>
                <input type="number" id="productPrice" placeholder="49.99" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Ссылки на изображения (по одной на строку)</label>
                <textarea id="productImages" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
            </div>
            <button class="btn btn-primary" onclick="createProduct()">Создать товар</button>
            <button class="btn btn-secondary" onclick="closeAddProductModal()">Отмена</button>
        </div>
    </div>

    <!-- Модальное окно редактирования товара -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeEditProductModal()">&times;</span>
                <h2>Редактировать товар</h2>
            </div>
            <input type="hidden" id="editProductId">
            <div class="form-group">
                <label>Название товара *</label>
                <input type="text" id="editProductName">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea id="editProductDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Цена (USD) *</label>
                <input type="number" id="editProductPrice" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Ссылки на изображения (по одной на строку)</label>
                <textarea id="editProductImages"></textarea>
            </div>
            <button class="btn btn-primary" onclick="updateProduct()">Сохранить</button>
            <button class="btn btn-secondary" onclick="closeEditProductModal()">Отмена</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let token = localStorage.getItem('token');
        let accountType = localStorage.getItem('accountType');

        // Проверка авторизации при загрузке
        window.onload = async function() {
            console.log('Loading page...');
            console.log('Token:', token);
            console.log('AccountType:', accountType);

            if (token && accountType) {
                console.log('User is authenticated, loading dashboard...');
                if (accountType === 'shop') {
                    console.log('Loading shop dashboard');
                    await loadShopDashboard();
                } else if (accountType === 'admin') {
                    console.log('Loading admin dashboard');
                    await loadAdminDashboard();
                } else {
                    console.log('Unknown account type:', accountType);
                    document.getElementById('loginPage').style.display = 'flex';
                }
            } else {
                console.log('User not authenticated, showing login page');
                document.getElementById('loginPage').style.display = 'flex';
            }
        };

        // Вход через Google
        async function loginWithGoogle() {
            try {
                // По умолчанию создаем магазин, роль admin назначается вручную
                const response = await fetch(`${API_URL}/api/v1/auth/google/url?account_type=shop`);
                const data = await response.json();

                // Перенаправляем на Google OAuth
                window.location.href = data.authorization_url;
            } catch (error) {
                alert('Ошибка при получении URL авторизации: ' + error.message);
            }
        }

        // Выход
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('accountType');
            token = null;
            accountType = null;

            document.getElementById('shopDashboard').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        }

        // API запрос
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_URL}${endpoint}`, options);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка запроса');
            }

            return await response.json();
        }

        // Показать уведомление
        function showAlert(message, type = 'success', container = 'alertContainer') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const alertContainer = document.getElementById(container);
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // === ПАНЕЛЬ МАГАЗИНА ===

        async function loadShopDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('shopDashboard').style.display = 'block';

            try {
                // Загрузка информации о магазине
                const shopInfo = await apiRequest('/api/v1/shops/me');
                document.getElementById('shopName').textContent = shopInfo.shop_name;
                document.getElementById('shopAvatar').textContent = shopInfo.shop_name[0].toUpperCase();
                document.getElementById('profileShopName').value = shopInfo.shop_name;
                document.getElementById('profileEmail').value = shopInfo.email;
                document.getElementById('profileDescription').value = shopInfo.description || '';

                // Загрузка аналитики
                const analytics = await apiRequest('/api/v1/shops/me/analytics');
                document.getElementById('totalProducts').textContent = analytics.total_products;
                document.getElementById('activeProducts').textContent = analytics.active_products;
                document.getElementById('totalViews').textContent = analytics.total_views;
                document.getElementById('totalTryOns').textContent = analytics.total_try_ons;

                // Загрузка товаров
                await loadShopProducts();
            } catch (error) {
                showAlert('Ошибка загрузки данных: ' + error.message, 'error');
            }
        }

        async function loadShopProducts() {
            try {
                const products = await apiRequest('/api/v1/shops/me/products');
                const container = document.getElementById('productsList');

                if (products.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>У вас пока нет товаров</p></div>';
                    return;
                }

                container.innerHTML = products.map(product => `
                    <div class="product-card">
                        <div class="product-image">
                            ${product.images && product.images.length > 0
                                ? `<img src="${product.images[0]}" alt="${product.name}">`
                                : 'Нет изображения'}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price}</div>
                            <span class="product-status status-${product.moderation_status}">
                                ${product.moderation_status === 'pending' ? 'На модерации' :
                                  product.moderation_status === 'approved' ? 'Одобрен' : 'Отклонен'}
                            </span>
                            <div class="product-actions">
                                <button class="btn btn-secondary" onclick="openEditProduct(${product.id})">Изменить</button>
                                <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Удалить</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Ошибка загрузки товаров: ' + error.message, 'error');
            }
        }

        async function updateShopProfile() {
            try {
                const data = {
                    shop_name: document.getElementById('profileShopName').value,
                    description: document.getElementById('profileDescription').value
                };

                await apiRequest('/api/v1/shops/me', 'PUT', data);
                showAlert('Профиль успешно обновлен', 'success');
                await loadShopDashboard();
            } catch (error) {
                showAlert('Ошибка обновления профиля: ' + error.message, 'error');
            }
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').classList.add('active');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImages').value = '';
        }

        async function createProduct() {
            try {
                const name = document.getElementById('productName').value;
                const price = parseFloat(document.getElementById('productPrice').value);

                if (!name || !price) {
                    showAlert('Заполните название и цену', 'error');
                    return;
                }

                const data = {
                    name,
                    price,
                    description: document.getElementById('productDescription').value || null,
                    images: document.getElementById('productImages').value
                        ? document.getElementById('productImages').value.split('\n').filter(url => url.trim())
                        : null
                };

                await apiRequest('/api/v1/products/', 'POST', data);
                showAlert('Товар успешно создан и отправлен на модерацию', 'success');
                closeAddProductModal();
                await loadShopProducts();
            } catch (error) {
                showAlert('Ошибка создания товара: ' + error.message, 'error');
            }
        }

        async function openEditProduct(productId) {
            try {
                const product = await apiRequest(`/api/v1/products/${productId}`);

                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductDescription').value = product.description || '';
                document.getElementById('editProductPrice').value = product.price;
                document.getElementById('editProductImages').value = product.images ? product.images.join('\n') : '';

                document.getElementById('editProductModal').classList.add('active');
            } catch (error) {
                showAlert('Ошибка загрузки товара: ' + error.message, 'error');
            }
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').classList.remove('active');
        }

        async function updateProduct() {
            try {
                const productId = document.getElementById('editProductId').value;
                const data = {
                    name: document.getElementById('editProductName').value,
                    description: document.getElementById('editProductDescription').value || null,
                    price: parseFloat(document.getElementById('editProductPrice').value),
                    images: document.getElementById('editProductImages').value
                        ? document.getElementById('editProductImages').value.split('\n').filter(url => url.trim())
                        : null
                };

                await apiRequest(`/api/v1/products/${productId}`, 'PUT', data);
                showAlert('Товар успешно обновлен', 'success');
                closeEditProductModal();
                await loadShopProducts();
            } catch (error) {
                showAlert('Ошибка обновления товара: ' + error.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Вы уверены, что хотите удалить этот товар?')) {
                return;
            }

            try {
                await apiRequest(`/api/v1/products/${productId}`, 'DELETE');
                showAlert('Товар успешно удален', 'success');
                await loadShopProducts();
            } catch (error) {
                showAlert('Ошибка удаления товара: ' + error.message, 'error');
            }
        }

        // === ПАНЕЛЬ АДМИНИСТРАТОРА ===

        async function loadAdminDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';

            try {
                const dashboard = await apiRequest('/api/v1/admin/dashboard');
                document.getElementById('adminTotalUsers').textContent = dashboard.total_users;
                document.getElementById('adminTotalShops').textContent = dashboard.total_shops;
                document.getElementById('adminTotalProducts').textContent = dashboard.total_products;
                document.getElementById('adminPendingModeration').textContent = dashboard.pending_moderation;

                await loadModerationQueue();
            } catch (error) {
                showAlert('Ошибка загрузки данных: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'moderation') loadModerationQueue();
            if (tab === 'refunds') loadRefunds();
            if (tab === 'settings') loadSettings();
        }

        async function loadModerationQueue() {
            try {
                const products = await apiRequest('/api/v1/admin/moderation/queue');
                const container = document.getElementById('moderationQueue');

                if (products.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Нет товаров на модерации</p></div>';
                    return;
                }

                container.innerHTML = products.map(product => `
                    <div class="product-card">
                        <div class="product-image">
                            ${product.images && product.images.length > 0
                                ? `<img src="${product.images[0]}" alt="${product.name}">`
                                : 'Нет изображения'}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price}</div>
                            <p style="font-size: 13px; color: #666; margin: 8px 0;">
                                ${product.description || 'Нет описания'}
                            </p>
                            <div class="product-actions">
                                <button class="btn btn-success" onclick="moderateProduct(${product.id}, 'approve')">Одобрить</button>
                                <button class="btn btn-danger" onclick="moderateProduct(${product.id}, 'reject')">Отклонить</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Ошибка загрузки очереди: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        async function moderateProduct(productId, action) {
            try {
                const endpoint = action === 'approve'
                    ? `/api/v1/admin/moderation/${productId}/approve`
                    : `/api/v1/admin/moderation/${productId}/reject`;

                await apiRequest(endpoint, 'POST', { action });
                showAlert(`Товар успешно ${action === 'approve' ? 'одобрен' : 'отклонен'}`, 'success', 'adminAlertContainer');
                await loadModerationQueue();
                await loadAdminDashboard();
            } catch (error) {
                showAlert('Ошибка модерации: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        async function loadRefunds() {
            try {
                const status = document.getElementById('refundStatusFilter').value;
                const refunds = await apiRequest(`/api/v1/admin/refunds${status ? '?status=' + status : ''}`);
                const container = document.getElementById('refundsList');

                if (refunds.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Нет запросов на возврат</p></div>';
                    return;
                }

                container.innerHTML = refunds.map(refund => `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p><strong>ID:</strong> ${refund.id}</p>
                        <p><strong>Причина:</strong> ${refund.reason}</p>
                        <p><strong>Статус:</strong> ${refund.status}</p>
                        ${refund.status === 'pending' ? `
                            <div style="margin-top: 10px;">
                                <button class="btn btn-success" onclick="processRefund(${refund.id}, 'approve')">Одобрить</button>
                                <button class="btn btn-danger" onclick="processRefund(${refund.id}, 'reject')">Отклонить</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Ошибка загрузки возвратов: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        async function processRefund(refundId, action) {
            try {
                await apiRequest(`/api/v1/admin/refunds/${refundId}/process`, 'POST', { action });
                showAlert(`Возврат ${action === 'approve' ? 'одобрен' : 'отклонен'}`, 'success', 'adminAlertContainer');
                await loadRefunds();
            } catch (error) {
                showAlert('Ошибка обработки возврата: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        async function loadSettings() {
            try {
                const settings = await apiRequest('/api/v1/admin/settings');
                const container = document.getElementById('settingsList');

                container.innerHTML = settings.map(setting => `
                    <div class="form-group">
                        <label>${setting.description || setting.key}</label>
                        <input type="text" value="${setting.value}" id="setting_${setting.key}">
                        <button class="btn btn-primary" onclick="updateSetting('${setting.key}')">Сохранить</button>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Ошибка загрузки настроек: ' + error.message, 'error', 'adminAlertContainer');
            }
        }

        async function updateSetting(key) {
            try {
                const value = document.getElementById(`setting_${key}`).value;
                await apiRequest(`/api/v1/admin/settings/${key}`, 'PUT', { key, value });
                showAlert('Настройка обновлена', 'success', 'adminAlertContainer');
            } catch (error) {
                showAlert('Ошибка обновления настройки: ' + error.message, 'error', 'adminAlertContainer');
            }
        }
    </script>
</body>
</html>
